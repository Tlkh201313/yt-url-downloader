<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber YouTube Downloader</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background': '#1f202b',
                        'foreground': '#e6f0ff',
                        'card': '#242633',
                        'primary': '#00ffff', // Bright Cyan
                        'primary-foreground': '#1f202b',
                        'secondary': '#a020f0', // Purple Neon
                        'secondary-foreground': '#1f202b',
                        'muted': '#33354a',
                        'muted-foreground': '#94b3c4',
                        'accent': '#ff33d1', // Pink Neon
                        'accent-foreground': '#1f202b',
                        'destructive': '#cd3a2f',
                        'border': '#33354a',
                        'input': '#33354a',
                        'ring': '#00ffff',
                    },
                }
            }
        }
    </script>
    
    <style>
        /* Custom styling for the select box */
        .cyber-select {
            background-color: var(--color-input); 
            color: var(--color-foreground);
            border: 1px solid var(--color-primary); 
            padding: 0.5rem;
            border-radius: 0.125rem;
            box-shadow: inset 0 0 5px var(--color-primary)33;
            height: 3rem;
            appearance: none; 
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='oklch(0.7 0.2 200)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%;
            background-size: 0.65em auto;
        }

        /* Animated gradient background */
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .cyber-gradient {
            background: linear-gradient(-45deg, #1f202b, #242633, #2b2e3e, #1f202b);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
        }

        /* Cyber glow effect */
        .cyber-glow {
            box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff80;
        }
    </style>

    <script>
        $(function () {
            // Function to enable/disable UI elements
            function setUIState(isDisabled) {
                $("#btn_fetch, #btn_download, #txt_url, #select_format").attr('disabled', isDisabled);
                if (isDisabled) {
                    $("#btn_download").removeClass('cyber-glow');
                }
            }

            // --- FETCH VIDEO INFORMATION ---
            $("#btn_fetch").click(function (e) {
                e.preventDefault(); 
                let url = $("#txt_url").val();
                
                if (!url) {
                    alert('Please paste a video URL.');
                    return;
                }
                
                $("#select_format").html('<option value="">Fetching formats...</option>');
                setUIState(true);

                // Encode the URL before sending it
                $.get('./video_info.php?video_url=' + encodeURIComponent(url), function (data) {
                    setUIState(false);
                    
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch (err) {
                            alert('Error: Failed to parse server response. Check console for raw data.');
                            console.error("Failed to parse JSON:", data);
                            $("#select_format").html('<option value="">Parsing failed</option>');
                            return;
                        }
                    }
                    
                    // Handle the clean error response from video_info.php
                    if (data.error) {
                        alert('Server Error: ' + data.error + (data.details ? "\nDetails: " + data.details : ""));
                        $("#select_format").html('<option value="">' + data.error + '</option>');
                        return;
                    }

                    // CRITICAL FIX: The new backend uses the 'formats' key
                    let formats = data.formats;

                    if (!formats || formats.length === 0) {
                        alert('No usable video formats were found!');
                        $("#select_format").html('<option value="">No formats found</option>');
                        return;
                    }

                    let formatOptions = '<option value="">Select a format...</option>';
                    let videoTitle = data.title || 'video'; // Get the title for the download filename
                    
                    // Filter and display formats
                    formats.forEach(function(f) {
                        // Filter out formats missing essential properties or are unusable (like combined streams)
                        if (!f.format_id || f.vcodec === 'none' && f.acodec === 'none' || f.downloader_options) {
                            return;
                        }
                        
                        // Calculate human-readable size
                        let size = f.filesize ? (f.filesize / 1024 / 1024).toFixed(2) + ' MB' : (f.filesize_approx ? ' ~' + (f.filesize_approx / 1024 / 1024).toFixed(2) + ' MB' : ' (Size unknown)');
                        
                        // Determine resolution or audio status
                        let resolution;
                        if (f.vcodec !== 'none' && f.height) {
                            resolution = f.height + 'p';
                        } else if (f.acodec !== 'none' && f.ext === 'mp3' || f.ext === 'm4a') {
                            resolution = 'Audio Only';
                        } else {
                            resolution = 'Stream Only';
                        }

                        let codec = f.ext ? f.ext.toUpperCase() : 'Unknown';

                        let optionText = `${codec} - ${resolution} [${size}] - ID: ${f.format_id}`;
                        
                        // Value stores the format_id for the download.php script
                        // data-url stores the video URL, data-filename stores the video title
                        formatOptions += `<option value="${f.format_id}" data-url="${encodeURIComponent(url)}" data-filename="${encodeURIComponent(videoTitle)}">${optionText}</option>`;
                    });

                    $('#select_format').html(formatOptions);
                    $("#btn_download").addClass('cyber-glow');
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    setUIState(false);
                    alert(`Failed to connect to the service. Status: ${textStatus}, Error: ${errorThrown}. Ensure Docker is running.`);
                    $("#select_format").html('<option value="">Connection error</option>');
                });
            });

            // --- DOWNLOAD SELECTED FORMAT ---
            $("#btn_download").click(function (e) {
                e.preventDefault();
                let selectedOption = $("#select_format option:selected");
                let formatId = selectedOption.val();
                let videoUrl = selectedOption.data('url');
                let filename = selectedOption.data('filename');
                
                if (!formatId) {
                    alert('Please select a video format first.');
                    return;
                }

                // Construct the download link for the new download.php script
                let downloadLink = `./download.php?video_url=${videoUrl}&format_id=${formatId}&filename=${filename}`;
                
                // Navigate to the download PHP script
                window.location.href = downloadLink;
            });
        });
    </script>
</head>
<body class="cyber-gradient min-h-screen p-4 flex items-start justify-center">
    <main class="w-full max-w-xl mx-auto mt-20">
        <div class="bg-card text-foreground p-8 rounded-lg shadow-xl border border-primary/50 cyber-glow">
            <h1 class="text-3xl font-bold mb-6 text-primary tracking-wider border-b border-secondary/50 pb-2">
                CYBER DRAIN
            </h1>
            <p class="text-sm text-muted-foreground mb-6">
                Enter a YouTube URL to retrieve available download streams.
            </p>

            <div class="flex space-x-2 mb-6">
                <input id="txt_url" type="text" placeholder="Paste YouTube Video URL here" 
                       class="flex-grow p-3 bg-input border border-border focus:border-primary/80 focus:ring-1 focus:ring-primary/50 rounded-sm text-foreground placeholder-muted-foreground transition duration-300">
                
                <button id="btn_fetch" 
                        class="bg-primary text-primary-foreground hover:bg-primary/80 transition duration-300 px-6 py-3 rounded-sm font-semibold">
                    Fetch
                </button>
            </div>

            <div class="space-y-4">
                <label for="select_format" class="text-sm font-medium text-secondary">
                    Select Format Stream:
                </label>
                <div class="relative">
                    <select id="select_format" class="w-full cyber-select">
                        <option value="">Enter URL and click Fetch</option>
                    </select>
                </div>

                <button id="btn_download" disabled
                        class="w-full bg-secondary text-secondary-foreground hover:bg-secondary/80 transition duration-300 py-3 rounded-sm font-semibold mt-4 disabled:opacity-50 disabled:cursor-not-allowed">
                    DOWNLOAD SELECTED
                </button>
            </div>
        </div>
    </main>
</body>
</html>